<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDR LVH IA - Terre du Milieu</title>
    <style>
        body { font-family: 'Georgia', serif; background: linear-gradient(to bottom, #228B22, #8B4513); color: #2F4F4F; padding: 20px; max-width: 700px; margin: auto; min-height: 100vh; }
        h1 { text-align: center; font-size: 28px; color: #DAA520; text-shadow: 2px 2px 4px #000; margin-bottom: 20px; }
        #narrative { border: 3px solid #DAA520; padding: 25px; background: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 19px; line-height: 1.8; font-style: italic; border-radius: 10px; box-shadow: 0 6px 12px rgba(0,0,0,0.4); min-height: 250px; max-height: 600px; overflow-y: auto; }
        #narrative p { margin: 12px 0; text-align: justify; }
        #read-time { font-size: 13px; color: #666; text-align: right; margin-top: 10px; font-style: normal; }
        #choices { display: flex; flex-direction: column; gap: 10px; }
        button { background: linear-gradient(#8B4513, #A0522D); color: white; border: none; padding: 15px; cursor: pointer; font-size: 16px; border-radius: 8px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        button:hover { background: linear-gradient(#A0522D, #CD853F); transform: translateY(-2px); }
        button:disabled { background: #696969; cursor: not-allowed; transform: none; }
        #loading { display: none; text-align: center; color: #DAA520; font-size: 16px; margin: 10px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #DAA520; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #controls { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        #pin-panel { background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        #logs { background: #f0f0f0; padding: 10px; border-radius: 5px; font-size: 12px; max-height: 100px; overflow-y: auto; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <h1>üó°Ô∏è JDR IA - Livre Dont Vous √ätes Le H√©ros üó°Ô∏è</h1>
    <div id="pin-panel">
        <h3>üîë PIN Famille (Parents)</h3>
        <input type="password" id="pin-input" placeholder="Entrez PIN (1234)" maxlength="4">
        <button onclick="checkPin()">Valider</button>
        <div id="parent-controls" style="display:none;">
            <button onclick="loadSave()">üìÇ Charger</button>
            <button onclick="resetGame()">üîÑ Reset</button>
            <button onclick="toggleLogs()">üìã Logs</button>
        </div>
    </div>
    <div id="narrative">Cliquez un choix pour commencer !</div>
    <div id="loading"><div class="spinner"></div> IA en cours... (3-8s)</div>
    <div id="choices"></div>
    <div id="logs"></div>
    <script>
        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let ws = null;
        const PIN = '1234';
        function connect() {
            ws = new WebSocket(`ws://localhost:8000/ws/${playerId}`);
            ws.onopen = () => console.log('Connect√©');
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('loading').style.display = 'none';
                if (data.error) {
                    document.getElementById('narrative').innerHTML = `<p style="color:red;">Erreur: ${data.error}</p>`;
                    return;
                }
                // Formatting narrative with paragraphs and reading time
                let narrative = data.narrative || data.description || '';
                const words = narrative.split(/\s+/).length;
                const readTime = Math.ceil(words / 200); // 200 mots/minute pour enfants

                document.getElementById('narrative').innerHTML = `
                    <div style="opacity:0; animation: fadeIn 0.8s forwards;">
                        <p>${narrative}</p>
                        <div id="read-time">üìñ Temps de lecture: ~${readTime} min (${words} mots)</div>
                    </div>
                `;

                // Add fade in animation if not exists
                if (!document.querySelector('style[data-animations]')) {
                    const style = document.createElement('style');
                    style.setAttribute('data-animations', 'true');
                    style.textContent = '@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }';
                    document.head.appendChild(style);
                }
                const choicesDiv = document.getElementById('choices');
                choicesDiv.innerHTML = '';
                (data.choices || []).forEach(choice => {
                    const btn = document.createElement('button');
                    btn.textContent = choice;
                    btn.onclick = () => sendChoice(choice);
                    choicesDiv.appendChild(btn);
                });
                localStorage.setItem(playerId, JSON.stringify(data));
            };
            ws.onclose = () => setTimeout(connect, 2000);
        }
        function sendChoice(choice) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                document.getElementById('loading').style.display = 'block';
                ws.send(choice);
            }
        }
        function checkPin() {
            if (document.getElementById('pin-input').value === PIN) {
                document.getElementById('parent-controls').style.display = 'block';
                document.getElementById('pin-panel').style.display = 'none';
            } else alert('PIN incorrect !');
        }
        function loadSave() {
            const saved = localStorage.getItem(playerId);
            if (saved) ws.send('load');
        }
        function resetGame() {
            if (confirm('Reset ?')) {
                localStorage.removeItem(playerId);
                ws.send('reset');
                location.reload();
            }
        }
        function toggleLogs() {
            document.getElementById('logs').style.display = document.getElementById('logs').style.display === 'block' ? 'none' : 'block';
        }
        connect();
        setTimeout(() => document.getElementById('pin-panel').style.display = 'block', 10000);
    </script>
</body>
</html>
